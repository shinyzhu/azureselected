<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How to use GitHub Actions to deploy a virtual machine | Azure Selected</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="/azureselected/favicon.ico">
    <meta name="description" content="Instructional blog that helps the non-developer community deploy Azure resources using GitHub Actions.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/azureselected/assets/css/0.styles.fe1e9048.css" as="style"><link rel="preload" href="/azureselected/assets/js/app.8a0b7483.js" as="script"><link rel="preload" href="/azureselected/assets/js/2.8d021b4d.js" as="script"><link rel="preload" href="/azureselected/assets/js/24.67816702.js" as="script"><link rel="preload" href="/azureselected/assets/js/3.32c85e2e.js" as="script"><link rel="preload" href="/azureselected/assets/js/5.554b9b17.js" as="script"><link rel="prefetch" href="/azureselected/assets/js/10.fa73f6fc.js"><link rel="prefetch" href="/azureselected/assets/js/11.e07babbc.js"><link rel="prefetch" href="/azureselected/assets/js/12.12214fd4.js"><link rel="prefetch" href="/azureselected/assets/js/13.b7275e3f.js"><link rel="prefetch" href="/azureselected/assets/js/14.d6b8a728.js"><link rel="prefetch" href="/azureselected/assets/js/15.31a19f47.js"><link rel="prefetch" href="/azureselected/assets/js/16.c3ccb867.js"><link rel="prefetch" href="/azureselected/assets/js/17.7d290d04.js"><link rel="prefetch" href="/azureselected/assets/js/18.4cc5d13c.js"><link rel="prefetch" href="/azureselected/assets/js/19.01296b5f.js"><link rel="prefetch" href="/azureselected/assets/js/20.84db9ad2.js"><link rel="prefetch" href="/azureselected/assets/js/21.6a1d22b6.js"><link rel="prefetch" href="/azureselected/assets/js/22.b38195a7.js"><link rel="prefetch" href="/azureselected/assets/js/23.53dea98b.js"><link rel="prefetch" href="/azureselected/assets/js/25.8e0307d1.js"><link rel="prefetch" href="/azureselected/assets/js/26.fb128a8f.js"><link rel="prefetch" href="/azureselected/assets/js/27.e8b0b7a9.js"><link rel="prefetch" href="/azureselected/assets/js/28.e625e9de.js"><link rel="prefetch" href="/azureselected/assets/js/29.aeb087ba.js"><link rel="prefetch" href="/azureselected/assets/js/30.8ef68534.js"><link rel="prefetch" href="/azureselected/assets/js/31.6b43ffde.js"><link rel="prefetch" href="/azureselected/assets/js/32.b2f60498.js"><link rel="prefetch" href="/azureselected/assets/js/33.ef0db925.js"><link rel="prefetch" href="/azureselected/assets/js/34.c990c7e7.js"><link rel="prefetch" href="/azureselected/assets/js/35.177548dd.js"><link rel="prefetch" href="/azureselected/assets/js/36.be924c7e.js"><link rel="prefetch" href="/azureselected/assets/js/37.c4a329a3.js"><link rel="prefetch" href="/azureselected/assets/js/38.88502f70.js"><link rel="prefetch" href="/azureselected/assets/js/39.b70a599f.js"><link rel="prefetch" href="/azureselected/assets/js/4.f7cbda98.js"><link rel="prefetch" href="/azureselected/assets/js/40.af1f7c88.js"><link rel="prefetch" href="/azureselected/assets/js/41.09f3637f.js"><link rel="prefetch" href="/azureselected/assets/js/42.91268a34.js"><link rel="prefetch" href="/azureselected/assets/js/43.8bc4e597.js"><link rel="prefetch" href="/azureselected/assets/js/44.e75fe39d.js"><link rel="prefetch" href="/azureselected/assets/js/45.36f7e780.js"><link rel="prefetch" href="/azureselected/assets/js/46.d83d96f0.js"><link rel="prefetch" href="/azureselected/assets/js/47.b54cc2ca.js"><link rel="prefetch" href="/azureselected/assets/js/48.9b7655b1.js"><link rel="prefetch" href="/azureselected/assets/js/49.dc3e7585.js"><link rel="prefetch" href="/azureselected/assets/js/50.44491727.js"><link rel="prefetch" href="/azureselected/assets/js/51.b3cc832a.js"><link rel="prefetch" href="/azureselected/assets/js/52.4b3f7433.js"><link rel="prefetch" href="/azureselected/assets/js/53.d0efb5a8.js"><link rel="prefetch" href="/azureselected/assets/js/54.41189e23.js"><link rel="prefetch" href="/azureselected/assets/js/55.0604b61d.js"><link rel="prefetch" href="/azureselected/assets/js/56.d1bb56be.js"><link rel="prefetch" href="/azureselected/assets/js/57.2ae826e1.js"><link rel="prefetch" href="/azureselected/assets/js/58.fcca3b58.js"><link rel="prefetch" href="/azureselected/assets/js/59.3da7d882.js"><link rel="prefetch" href="/azureselected/assets/js/6.ef320c88.js"><link rel="prefetch" href="/azureselected/assets/js/60.3f06229c.js"><link rel="prefetch" href="/azureselected/assets/js/61.6e57367f.js"><link rel="prefetch" href="/azureselected/assets/js/62.3b222c6c.js"><link rel="prefetch" href="/azureselected/assets/js/63.8a7f0932.js"><link rel="prefetch" href="/azureselected/assets/js/7.51b986da.js"><link rel="prefetch" href="/azureselected/assets/js/8.a9358b51.js"><link rel="prefetch" href="/azureselected/assets/js/9.b8eed478.js">
    <link rel="stylesheet" href="/azureselected/assets/css/0.styles.fe1e9048.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/azureselected/" class="home-link router-link-active"><img src="/azureselected/img/logo_azure.svg" alt="Azure Selected" class="logo"> <span class="site-name can-hide">Azure Selected</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/azureselected/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/azureselected/content/" class="nav-link router-link-active">
  Content
</a></div><div class="nav-item"><a href="/azureselected/tags.html" class="nav-link">
  Tags
</a></div><div class="nav-item"><a href="https://wj.qq.com/s2/5227985/7213/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Join Us
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/azureselected/zh-cn/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/azureselected/zh-tw/" class="nav-link">
  繁體中文
</a></li></ul></div></div> <a href="https://github.com/shinyzhu/azureselected" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/azureselected/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/azureselected/content/" class="nav-link router-link-active">
  Content
</a></div><div class="nav-item"><a href="/azureselected/tags.html" class="nav-link">
  Tags
</a></div><div class="nav-item"><a href="https://wj.qq.com/s2/5227985/7213/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Join Us
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/azureselected/zh-cn/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/azureselected/zh-tw/" class="nav-link">
  繁體中文
</a></li></ul></div></div> <a href="https://github.com/shinyzhu/azureselected" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>How to use GitHub Actions to deploy a virtual machine</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#github-actions-terminology" class="sidebar-link">GitHub Actions Terminology</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#what-do-you-want-to-build" class="sidebar-link">What do you want to build?</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#how-do-i-instruct-the-action" class="sidebar-link">How do I instruct the Action?</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#metadata" class="sidebar-link">Metadata</a></li><li class="sidebar-sub-header"><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#environment-variables" class="sidebar-link">Environment variables:</a></li><li class="sidebar-sub-header"><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#triggers" class="sidebar-link">Triggers</a></li><li class="sidebar-sub-header"><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#jobs" class="sidebar-link">Jobs</a></li><li class="sidebar-sub-header"><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#steps" class="sidebar-link">Steps</a></li></ul></li><li><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#monitoring-the-github-action-running" class="sidebar-link">Monitoring the GitHub Action running</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/azureselected/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.html#things-to-think-about" class="sidebar-link">Things to think about</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="how-to-use-github-actions-to-deploy-a-virtual-machine"><a href="#how-to-use-github-actions-to-deploy-a-virtual-machine" class="header-anchor">#</a> How to use GitHub Actions to deploy a virtual machine</h1> <div class="content-meta"><hr> <p>From:  <a href="https://techcommunity.microsoft.com/t5/itops-talk-blog/how-to-use-github-actions-to-deploy-an-azure-virtual-machine/ba-p/1092015">https://techcommunity.microsoft.com/t5/itops-talk-blog/how-to-use-github-actions-to-deploy-an-azure-virtual-machine/ba-p/1092015</a></p> <p>By:  Sarah Lean | 1/22/2020</p> <!----> <div class="tags-head"><span><a href="/azureselected/tags.html#Azure Virtual Machine">
      Azure Virtual Machine
    </a><a href="/azureselected/tags.html#GitHub Actions">
      GitHub Actions
    </a></span></div> <hr></div> <p>Hands up if you are used to deploy servers either by unpacking them from a box or using a graphical user interface (GUI)? Yip, that’s me and it's where I’ve built my career. However, over the last few years I’ve been getting more and more used to deploying servers and their supporting resources via code. Either using something like PowerShell or Azure CLI, or sometimes a combination of both.</p> <p>I’ve also taught myself how to use tools such as Visual Studio Code, Git, GitHub or even Azure DevOps to get the task done.  It’s not been an easy journey but what it has been is fun and a challenge.</p> <p>At the end of 2019 GitHub announced <a href="https://github.blog/2019-11-14-powering-community-led-innovation-with-github-actions/" target="_blank" rel="noopener noreferrer">GitHub Actions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, a new way to automate deployment of code from GitHub repositories.  I’ve been watching with interest as my developer focused colleagues and friends dig into the new service and show examples of it being used and have decided to take a look at it myself and see what it can do for the IT Pro community, as I’m a firm believer that these types of tools can offer IT Pros great opportunities as well.</p> <h2 id="github-actions-terminology"><a href="#github-actions-terminology" class="header-anchor">#</a> <strong>GitHub Actions Terminology</strong></h2> <p>There is some new terminology that comes with GitHub Actions, so let’s define those before we dig in.</p> <ul><li><strong>Action</strong> – these define what we can do, we can either get them from the marketplace (free) or build our own</li> <li><strong>Workflow</strong> – A collection of Environment variables, Jobs and Steps that are completed when an event happens</li> <li><strong>Jobs</strong> – What the workflow will do</li> <li><strong>Steps</strong> - A task undertaken by a Job using an Action</li> <li><strong>Event</strong> – Something that happens and triggers a workflow, e.g a commit is pushed to a repository, an issue or pull request is issued</li></ul> <h2 id="what-do-you-want-to-build"><a href="#what-do-you-want-to-build" class="header-anchor">#</a> <strong>What do you want to build?</strong></h2> <p>Keeping it simple, I want my GitHub Action to build a virtual machine (VM) within Azure. Keeping it really simple I want it to build the VM and it’s associated supporting technology (disk, network interface, virtual network, storage account, etc) within the same resource group.  This isn’t exactly best practice but is an easy example to start with and one that is well known/documented.</p> <p>I can use four blocks of Azure CLI code to build the VM within Azure.  The first block of code helps log into my Azure subscription using an Azure Service Principal and perform the necessary steps to create the VM.</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token comment">#region Login</span>
<span class="token comment"># This logs into Azure with a Service Principal Account</span>
<span class="token comment">#</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;Logging in to Azure with a service principal...&quot;</span>
az login `
    <span class="token operator">--</span>service-principal `
    <span class="token operator">--</span>username <span class="token variable">$servicePrincipal</span> `
    <span class="token operator">--</span>password <span class="token variable">$servicePrincipalSecret</span> `
    <span class="token operator">--</span>tenant <span class="token variable">$servicePrincipalTenantId</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;Done&quot;</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;&quot;</span>
<span class="token comment">#endregion</span>
</code></pre></div><p>The next section selects the correct subscription, just to be sure my resources go to the right place:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token comment">#region Subscription</span>
<span class="token comment">#This sets the subscription the resources will be created in</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;Setting default azure subscription...&quot;</span>
az account <span class="token function">set</span> `
    <span class="token operator">--</span>subscription <span class="token variable">$azureSubscriptionName</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;Done&quot;</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;&quot;</span>
<span class="token comment">#endregion</span>
</code></pre></div><p>The third section creates the resource group for my VM to live in:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token comment">#region Create Resource Group</span>
<span class="token comment"># This creates the resource group used to house the VM</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;Creating resource group <span class="token variable">$resourceGroupName</span> in region <span class="token variable">$resourceGroupNameRegion</span>...&quot;</span>
az <span class="token function">group</span> create `
    <span class="token operator">--</span>name <span class="token variable">$resourceGroupName</span> `
    <span class="token operator">--</span>location <span class="token variable">$resourceGroupNameRegion</span>
    <span class="token function">Write-Output</span> <span class="token string">&quot;Done creating resource group&quot;</span>
    <span class="token function">Write-Output</span> <span class="token string">&quot;&quot;</span>
<span class="token comment">#endregion</span>
</code></pre></div><p>And the fourth section creates the VM within that resource group:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token comment">#region Create VM</span>
<span class="token comment"># Create a VM in the resource group</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;Creating VM...&quot;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    az vm create  `
        <span class="token operator">--</span>resource-<span class="token function">group</span> <span class="token variable">$resourceGroupName</span> `
        <span class="token operator">--</span>name <span class="token variable">$serverName</span> `
        <span class="token operator">--</span>image win2016datacenter `
        <span class="token operator">--</span>admin-username <span class="token variable">$adminLogin</span> `
        <span class="token operator">--</span>admin-password <span class="token variable">$adminPassword</span>
    <span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token function">Write-Output</span> <span class="token string">&quot;VM already exists&quot;</span>
    <span class="token punctuation">}</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;Done creating VM&quot;</span>
<span class="token function">Write-Output</span> <span class="token string">&quot;&quot;</span>
<span class="token comment">#endregion</span>
</code></pre></div><p>The code isn’t complex and is a well-known example you can see in a lot of Documentation and tutorials. Within my script I’ve used various parameters to allow me to store the information securely or pass it in from my workflow file.  You can find my full PowerShell script <a href="https://gist.github.com/weeyin83/81e7a7bf3caf3d0bce787db5d562b47e?WT.mc_id=blog-itops-salean" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="how-do-i-instruct-the-action"><a href="#how-do-i-instruct-the-action" class="header-anchor">#</a> <strong>How do I instruct the Action?</strong></h2> <p>To kick off the VM build we construct a Workflow file. This is in the form of YAML. You can call your workflow file anything you want as long as it ends with. yml or .yaml as the extension type. It also needs to be stored within a specific directory within your GitHub repository - <strong>.github/workflows</strong></p> <p>Your workflow file is split up into several sections, let’s look at each of them individually:</p> <h3 id="metadata"><a href="#metadata" class="header-anchor">#</a> <strong>Metadata</strong></h3> <p>We start off with some naming the workflow:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> GitHub for IT Pro CI/CD Pipeline
</code></pre></div><h3 id="environment-variables"><a href="#environment-variables" class="header-anchor">#</a> <strong>Environment variables:</strong></h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">Env</span><span class="token punctuation">:</span>

  <span class="token key atrule">OUTPUT_PATH</span><span class="token punctuation">:</span> $
</code></pre></div><h3 id="triggers"><a href="#triggers" class="header-anchor">#</a> <strong>Triggers</strong></h3> <p>We then instruct how the action will be <a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions#on" target="_blank" rel="noopener noreferrer">triggered<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>; I have set my action to start whenever something is pushed to the repository:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>push<span class="token punctuation">]</span>
</code></pre></div><h3 id="jobs"><a href="#jobs" class="header-anchor">#</a> <strong>Jobs</strong></h3> <p>Now we start to declare the jobs that our workflow will do, we have to start by declaring what platform our Workflow will run on (Linux, MacOS or Windows).</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">jobs</span><span class="token punctuation">:</span>

<span class="token comment"># Deploy VM in Azure</span>

  <span class="token key atrule">DeployVM</span><span class="token punctuation">:</span>

    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> windows<span class="token punctuation">-</span>latest
</code></pre></div><h3 id="steps"><a href="#steps" class="header-anchor">#</a> <strong>Steps</strong></h3> <p>Now we can start with the steps within the workflow. The first step I’ve instructed my workflow to do a checkout. This takes the files/code from my repository and puts it into <strong>$github.workspace</strong> for my workflow to access it.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">steps</span><span class="token punctuation">:</span>

    <span class="token comment"># checkout code from repo</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> checkout repo

      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout
</code></pre></div><p>The next step we have is one where we tell the workflow to look for the PowerShell script that helps to build the VM:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> look for ps1 file

      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span>

        ls '$\IaC\AzCLI'
</code></pre></div><p>And the last step in our workflow is to deploy and provision the VM:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code> <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> provision virtual machine in azure

      <span class="token key atrule">env</span><span class="token punctuation">:</span>

        <span class="token key atrule">RESOURCE_GROUP</span><span class="token punctuation">:</span> rg<span class="token punctuation">-</span>githubitpro

        <span class="token key atrule">RESOURCE_GROUP_REGION</span><span class="token punctuation">:</span> southcentralus

        <span class="token key atrule">SERVER_NAME</span><span class="token punctuation">:</span> gihtubactions

        <span class="token key atrule">ADMIN_LOGIN</span><span class="token punctuation">:</span> sarah

      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">&gt;</span>

        powershell <span class="token punctuation">-</span>command &quot;&amp; '$\IaC\AzCLI\vmcreation.ps1'&quot;

        <span class="token punctuation">-</span>servicePrincipal $

        <span class="token punctuation">-</span>servicePrincipalSecret $

        <span class="token punctuation">-</span>servicePrincipalTenantId $

        <span class="token punctuation">-</span>azureSubscriptionName $

        <span class="token punctuation">-</span>resourceGroupName %RESOURCE_GROUP%

        <span class="token punctuation">-</span>resourceGroupNameRegion %RESOURCE_GROUP_REGION%

        <span class="token punctuation">-</span>serverName %SERVER_NAME%

        <span class="token punctuation">-</span>adminLogin %ADMIN_LOGIN%

        <span class="token punctuation">-</span>adminPassword $
</code></pre></div><p>Now there is a lot to that step so let’s break down what we are doing even further:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> provision virtual machine in azure

      <span class="token key atrule">env</span><span class="token punctuation">:</span>

        <span class="token key atrule">RESOURCE_GROUP</span><span class="token punctuation">:</span> rg<span class="token punctuation">-</span>githubitpro

        <span class="token key atrule">RESOURCE_GROUP_REGION</span><span class="token punctuation">:</span> southcentralus

        <span class="token key atrule">SERVER_NAME</span><span class="token punctuation">:</span> gihtubactions

        <span class="token key atrule">ADMIN_LOGIN</span><span class="token punctuation">:</span> sarah
</code></pre></div><p>This first part is declaring some environment variables, here I am setting my Azure Resource Group name, the region I want the resource group to be deployed in, the name of my virtual machine (server) and the name of the admin login account that will be created for that VM.</p> <p>The second stage of the step is telling my workflow to call my PowerShell script and pass in the following variables from the workflow and <a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/creating-and-using-encrypted-secrets" target="_blank" rel="noopener noreferrer">GitHub Secrets store<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.  To allow GitHub Actions to deploy resources within my Azure Subscription I have created an Azure Service Principal. If you’ve never worked within them before I wrote an article covering how to create and work with them <a href="https://techcommunity.microsoft.com/t5/itops-talk-blog/working-with-azure-service-principal-accounts/ba-p/1086961?WT.mc_id=blog-itopstalk-salean" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>run: &gt;

        powershell <span class="token operator">-</span>command <span class="token string">&quot;&amp; '$\IaC\AzCLI\vmcreation.ps1'&quot;</span>

        <span class="token operator">-</span>servicePrincipal $

        <span class="token operator">-</span>servicePrincipalSecret $

        <span class="token operator">-</span>servicePrincipalTenantId $

        <span class="token operator">-</span>azureSubscriptionName $

        <span class="token operator">-</span>resourceGroupName <span class="token operator">%</span>RESOURCE_GROUP%

        <span class="token operator">-</span>resourceGroupNameRegion <span class="token operator">%</span>RESOURCE_GROUP_REGION%

        <span class="token operator">-</span>serverName <span class="token operator">%</span>SERVER_NAME%

        <span class="token operator">-</span>adminLogin <span class="token operator">%</span>ADMIN_LOGIN%

        <span class="token operator">-</span>adminPassword $
</code></pre></div><p>For a full copy of this workflow file, you can find it <a href="https://gist.github.com/weeyin83/b63d320cc814dee9aebb599b847d0a49" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="monitoring-the-github-action-running"><a href="#monitoring-the-github-action-running" class="header-anchor">#</a> Monitoring the GitHub Action running</h2> <p>When the Action is running you can monitor its progress. When you navigate to your repository on the GitHub website you will see a tab called Actions, click into that will take you into the Workflow section. You can create new workflows, edit workflows and monitor the progress of the workflows running.</p> <p><img src="https://gxcuf89792.i.lithium.com/t5/image/serverpage/image-id/163886i433300750608D8F9/image-size/large?v=1.0&amp;px=999" alt="undefined"><em>GitHub Actions Tab</em></p> <p><img src="https://gxcuf89792.i.lithium.com/t5/image/serverpage/image-id/163889iD61736851B0DA262/image-size/large?v=1.0&amp;px=999" alt="undefined"><em>Monitoring GitHub Actions</em></p> <p>And once the workflow has completed you can check in your Azure subscription and hopefully see the resource created:</p> <p><img src="https://gxcuf89792.i.lithium.com/t5/image/serverpage/image-id/163887i4528F2147C235951/image-size/large?v=1.0&amp;px=999" alt="undefined"><em>Azure Resources</em></p> <h2 id="things-to-think-about"><a href="#things-to-think-about" class="header-anchor">#</a> Things to think about</h2> <p>My example workflow is a very basic one and the resource that I am deploying is a very basic one, however for me it was a great starting point to learn GitHub Actions. I’ve seen my colleagues use it for much more complex deployments and workflows, for example Aaron Powell is using it to <a href="https://www.aaron-powell.com/posts/2019-12-17-implementing-github-actions-for-my-blog/" target="_blank" rel="noopener noreferrer">deploy his blog<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>The <a href="https://github.com/weeyin83/vm-actions" target="_blank" rel="noopener noreferrer">repository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> I created to test out this deployment is a public one and the output of my workflow is available for anyone logged in or not to GitHub to view, which displays certain information that could be considered as sensitive such as my Azure Subscription ID and more importantly the Public IP address of my VM, which gives people with bad intentions an easy attack surface.  So, if you are testing GitHub Actions please be aware of this and vigilant on what you deploy in Azure and how it is secured.</p> <p>I've recorded a video of me walking through the code and each step, this video can be found here:
<a href="https://youtu.be/0kDr9OlAzlM" target="_blank" rel="noopener noreferrer">https://youtu.be/0kDr9OlAzlM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>I’d love to hear how other IT Pros are using GitHub Actions to deploy infrastructure, so please do reach out and share your stories!</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/shinyzhu/azureselected/edit/master/content/cloud-advocate/2020-02/how-to-use-github-actions-to-deploy-an-azure-virtual-machine.md" target="_blank" rel="noopener noreferrer">Edit on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/17/2020, 7:58:22 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/azureselected/assets/js/app.8a0b7483.js" defer></script><script src="/azureselected/assets/js/2.8d021b4d.js" defer></script><script src="/azureselected/assets/js/24.67816702.js" defer></script><script src="/azureselected/assets/js/3.32c85e2e.js" defer></script><script src="/azureselected/assets/js/5.554b9b17.js" defer></script>
  </body>
</html>
