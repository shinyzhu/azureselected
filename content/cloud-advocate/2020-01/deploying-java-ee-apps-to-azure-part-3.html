<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploying Java EE apps to Azure: Part 3 | Azure Selected</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="/azureselected/favicon.ico">
    <meta name="description" content="This is the final blog in a series of posts that explore different options for running Java EE workloads on Azure. In this part, we will run the Java EE app on a Kubernetes cluster in Azure.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/azureselected/assets/css/0.styles.fe1e9048.css" as="style"><link rel="preload" href="/azureselected/assets/js/app.8a0b7483.js" as="script"><link rel="preload" href="/azureselected/assets/js/2.8d021b4d.js" as="script"><link rel="preload" href="/azureselected/assets/js/20.84db9ad2.js" as="script"><link rel="preload" href="/azureselected/assets/js/3.32c85e2e.js" as="script"><link rel="preload" href="/azureselected/assets/js/5.554b9b17.js" as="script"><link rel="prefetch" href="/azureselected/assets/js/10.fa73f6fc.js"><link rel="prefetch" href="/azureselected/assets/js/11.e07babbc.js"><link rel="prefetch" href="/azureselected/assets/js/12.12214fd4.js"><link rel="prefetch" href="/azureselected/assets/js/13.b7275e3f.js"><link rel="prefetch" href="/azureselected/assets/js/14.d6b8a728.js"><link rel="prefetch" href="/azureselected/assets/js/15.31a19f47.js"><link rel="prefetch" href="/azureselected/assets/js/16.c3ccb867.js"><link rel="prefetch" href="/azureselected/assets/js/17.7d290d04.js"><link rel="prefetch" href="/azureselected/assets/js/18.4cc5d13c.js"><link rel="prefetch" href="/azureselected/assets/js/19.01296b5f.js"><link rel="prefetch" href="/azureselected/assets/js/21.6a1d22b6.js"><link rel="prefetch" href="/azureselected/assets/js/22.b38195a7.js"><link rel="prefetch" href="/azureselected/assets/js/23.53dea98b.js"><link rel="prefetch" href="/azureselected/assets/js/24.67816702.js"><link rel="prefetch" href="/azureselected/assets/js/25.8e0307d1.js"><link rel="prefetch" href="/azureselected/assets/js/26.fb128a8f.js"><link rel="prefetch" href="/azureselected/assets/js/27.e8b0b7a9.js"><link rel="prefetch" href="/azureselected/assets/js/28.e625e9de.js"><link rel="prefetch" href="/azureselected/assets/js/29.aeb087ba.js"><link rel="prefetch" href="/azureselected/assets/js/30.8ef68534.js"><link rel="prefetch" href="/azureselected/assets/js/31.6b43ffde.js"><link rel="prefetch" href="/azureselected/assets/js/32.b2f60498.js"><link rel="prefetch" href="/azureselected/assets/js/33.ef0db925.js"><link rel="prefetch" href="/azureselected/assets/js/34.c990c7e7.js"><link rel="prefetch" href="/azureselected/assets/js/35.177548dd.js"><link rel="prefetch" href="/azureselected/assets/js/36.be924c7e.js"><link rel="prefetch" href="/azureselected/assets/js/37.c4a329a3.js"><link rel="prefetch" href="/azureselected/assets/js/38.88502f70.js"><link rel="prefetch" href="/azureselected/assets/js/39.b70a599f.js"><link rel="prefetch" href="/azureselected/assets/js/4.f7cbda98.js"><link rel="prefetch" href="/azureselected/assets/js/40.af1f7c88.js"><link rel="prefetch" href="/azureselected/assets/js/41.09f3637f.js"><link rel="prefetch" href="/azureselected/assets/js/42.91268a34.js"><link rel="prefetch" href="/azureselected/assets/js/43.8bc4e597.js"><link rel="prefetch" href="/azureselected/assets/js/44.e75fe39d.js"><link rel="prefetch" href="/azureselected/assets/js/45.36f7e780.js"><link rel="prefetch" href="/azureselected/assets/js/46.d83d96f0.js"><link rel="prefetch" href="/azureselected/assets/js/47.b54cc2ca.js"><link rel="prefetch" href="/azureselected/assets/js/48.9b7655b1.js"><link rel="prefetch" href="/azureselected/assets/js/49.dc3e7585.js"><link rel="prefetch" href="/azureselected/assets/js/50.44491727.js"><link rel="prefetch" href="/azureselected/assets/js/51.b3cc832a.js"><link rel="prefetch" href="/azureselected/assets/js/52.4b3f7433.js"><link rel="prefetch" href="/azureselected/assets/js/53.d0efb5a8.js"><link rel="prefetch" href="/azureselected/assets/js/54.41189e23.js"><link rel="prefetch" href="/azureselected/assets/js/55.0604b61d.js"><link rel="prefetch" href="/azureselected/assets/js/56.d1bb56be.js"><link rel="prefetch" href="/azureselected/assets/js/57.2ae826e1.js"><link rel="prefetch" href="/azureselected/assets/js/58.fcca3b58.js"><link rel="prefetch" href="/azureselected/assets/js/59.3da7d882.js"><link rel="prefetch" href="/azureselected/assets/js/6.ef320c88.js"><link rel="prefetch" href="/azureselected/assets/js/60.3f06229c.js"><link rel="prefetch" href="/azureselected/assets/js/61.6e57367f.js"><link rel="prefetch" href="/azureselected/assets/js/62.3b222c6c.js"><link rel="prefetch" href="/azureselected/assets/js/63.8a7f0932.js"><link rel="prefetch" href="/azureselected/assets/js/7.51b986da.js"><link rel="prefetch" href="/azureselected/assets/js/8.a9358b51.js"><link rel="prefetch" href="/azureselected/assets/js/9.b8eed478.js">
    <link rel="stylesheet" href="/azureselected/assets/css/0.styles.fe1e9048.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/azureselected/" class="home-link router-link-active"><img src="/azureselected/img/logo_azure.svg" alt="Azure Selected" class="logo"> <span class="site-name can-hide">Azure Selected</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/azureselected/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/azureselected/content/" class="nav-link router-link-active">
  Content
</a></div><div class="nav-item"><a href="/azureselected/tags.html" class="nav-link">
  Tags
</a></div><div class="nav-item"><a href="https://wj.qq.com/s2/5227985/7213/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Join Us
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/azureselected/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/azureselected/zh-cn/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/azureselected/zh-tw/" class="nav-link">
  繁體中文
</a></li></ul></div></div> <a href="https://github.com/shinyzhu/azureselected" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/azureselected/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/azureselected/content/" class="nav-link router-link-active">
  Content
</a></div><div class="nav-item"><a href="/azureselected/tags.html" class="nav-link">
  Tags
</a></div><div class="nav-item"><a href="https://wj.qq.com/s2/5227985/7213/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Join Us
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/azureselected/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/azureselected/zh-cn/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/azureselected/zh-tw/" class="nav-link">
  繁體中文
</a></li></ul></div></div> <a href="https://github.com/shinyzhu/azureselected" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Deploying Java EE apps to Azure: Part 3</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/azureselected/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html#allow-aks-to-access-the-postgres-database" class="sidebar-link">Allow AKS to access the Postgres database</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/azureselected/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html#configure-azure-container-registry-to-work-with-azure-kubernetes-service" class="sidebar-link">Configure Azure Container Registry to work with Azure Kubernetes Service</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/azureselected/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html#build-and-push-the-image-to-azure-container-registry" class="sidebar-link">Build and push the image to Azure Container Registry</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/azureselected/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html#access-the-jsf-front-end" class="sidebar-link">Access the JSF front end</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/azureselected/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html#use-the-rest-api" class="sidebar-link">Use the REST API</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/azureselected/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.html#scale" class="sidebar-link">Scale</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="deploying-java-ee-apps-to-azure-part-3"><a href="#deploying-java-ee-apps-to-azure-part-3" class="header-anchor">#</a> Deploying Java EE apps to Azure: Part 3</h1> <div class="content-meta"><hr> <p>From:  <a href="https://medium.com/microsoftazure/deploying-java-ee-apps-to-azure-part-3-772e717bc4d1">https://medium.com/microsoftazure/deploying-java-ee-apps-to-azure-part-3-772e717bc4d1</a></p> <p>By:  Abhishek Gupta | 12/11/2019</p> <!----> <div class="tags-head"><span><a href="/azureselected/tags.html#Java EE">
      Java EE
    </a><a href="/azureselected/tags.html#Azure">
      Azure
    </a><a href="/azureselected/tags.html#IaaS">
      IaaS
    </a><a href="/azureselected/tags.html#Cloud Computing">
      Cloud Computing
    </a><a href="/azureselected/tags.html#Database">
      Database
    </a></span></div> <hr></div> <p>This is the final blog in a series of posts that explore different options for running Java EE workloads on Azure. In this part, we will run the Java EE app on a <a href="https://docs.microsoft.com/azure/aks/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">Kubernetes cluster in Azure<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p><img src="https://miro.medium.com/max/60/1*-gOAml8lPYXSaU5clFltdQ.png?q=20" alt="img"></p> <p><img src="https://miro.medium.com/max/980/1*-gOAml8lPYXSaU5clFltdQ.png" alt="img"></p> <p>The previous parts covered how to deploy a Java EE application to an application server which is set up in a <a href="https://azure.microsoft.com/services/virtual-machines/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">Virtual Machine on Microsoft Azure<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>as well as a Docker container in <a href="https://docs.microsoft.com/azure/container-instances/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">Azure Container Instances<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <ul><li><a href="https://medium.com/microsoftazure/deploying-java-ee-apps-to-azure-part-1-e895284b46d1" target="_blank" rel="noopener noreferrer">Part 1: Using Payara Server in a VM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://medium.com/microsoftazure/deploying-java-ee-apps-to-azure-part-2-37d73d0ee401" target="_blank" rel="noopener noreferrer">Part 2: Using Docker container<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>The example used in the blog post is a simple three-tier application that uses Java EE 8 specifications such as JAX-RS, EJB, CDI, JPA, JSF, Bean Validation. We will use the <a href="https://www.payara.fish/" target="_blank" rel="noopener noreferrer">Payara Server<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to deploy the application and use <a href="https://www.postgresql.org/" target="_blank" rel="noopener noreferrer">PostgreSQL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> as the relational database.</p> <p>During the course of the tutorial, we will cover:</p> <ul><li>Postgres setup on Azure</li> <li>Setup and configure Azure Kubernetes Service cluster and Azure Container Registry</li> <li>Dockerize the Java EE app</li> <li>Deploy the application to Kubernetes</li> <li>Explore its functionality</li></ul> <blockquote><p><em>Except for minor changes, the application used in this tutorial has been adapted from</em> <a href="https://github.com/m-reza-rahman/javaee-azure/tree/master/javaee" target="_blank" rel="noopener noreferrer"><em>this project</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <em>by</em> <a href="https://twitter.com/reza_rahman" target="_blank" rel="noopener noreferrer"><em>Reza Rahman</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <hr> <h1 id="pre-requisites"><a href="#pre-requisites" class="header-anchor">#</a> Pre-requisites</h1> <p>You will need a <a href="https://docs.microsoft.com/azure/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">Microsoft Azure account<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and the <a href="https://docs.microsoft.com/cli/azure/?view=azure-cli-latest&amp;WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">Azure CLI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to work through the tutorial.</p> <p>If you don’t have a Microsoft Azure account, go ahead and <a href="https://azure.microsoft.com/free/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">sign up for a free one!<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The Azure CLI is a cross-platform command-line experience for managing Azure resources — please install it using <a href="https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&amp;WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">these instructions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h1 id="first-things-first"><a href="#first-things-first" class="header-anchor">#</a> First things first…</h1> <p>Set your Azure Subscription ID using the Azure CLI which will be used for this tutorial.</p> <p>To set your Azure subscription ID</p> <div class="language- extra-class"><pre class="language-text"><code>export AZURE_SUBSCRIPTION_ID=[to be filled]
az account set --subscription $AZURE_SUBSCRIPTION_ID
</code></pre></div><p>Create a resource group that will contain all the services (resources) which you will create as a part of this tutorial. A resource group is like a logical container that holds related resources for an Azure solution. The resource group includes those resources that you want to manage as a group.</p> <p>To create a resource group</p> <div class="language- extra-class"><pre class="language-text"><code>export AZURE_RESOURCE_GROUP_NAME=[to be filled]export AZURE_LOCATION=[to be filled]
az group create --name $AZURE_RESOURCE_GROUP_NAME --location $AZURE_LOCATION
</code></pre></div><hr> <h1 id="install-postgres-on-azure"><a href="#install-postgres-on-azure" class="header-anchor">#</a> Install Postgres on Azure</h1> <p><a href="https://docs.microsoft.com/azure/postgresql/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">Azure Database for PostgreSQL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is a relational database service based on the open-source <a href="https://www.postgresql.org/" target="_blank" rel="noopener noreferrer">Postgres database engine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It’s a fully managed database-as-a-service offering which is available in two deployment options, as <a href="https://docs.microsoft.com/azure/postgresql/concepts-servers?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">a single server<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and as <a href="https://docs.microsoft.com/azure/postgresql/concepts-hyperscale-nodes?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">a Hyperscale (Citus) cluster<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p><em>We will be using the single server option for the purposes of this tutorial</em></p></blockquote> <p>We will use the <code>az postgres server create</code>command to create a Postgres server instance on Azure. First, set up some of the server properties such as the name, admin user, etc.</p> <div class="language- extra-class"><pre class="language-text"><code>export AZURE_POSTGRES_SERVER_NAME=[to be filled]
export AZURE_POSTGRES_ADMIN_USER=[to be filled]
export AZURE_POSTGRES_ADMIN_PASSWORD=[to be filled]
export SKU=B_Gen5_1
export STORAGE=5120
</code></pre></div><blockquote><p><em>For storage and SKU options, please refer to</em> <a href="https://docs.microsoft.com/azure/postgresql/concepts-pricing-tiers?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer"><em>the documentation</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>And, then invoke the command to initiate the database instance creation:</p> <div class="language- extra-class"><pre class="language-text"><code>az postgres server create --resource-group $AZURE_RESOURCE_GROUP_NAME --name $AZURE_POSTGRES_SERVER_NAME  --location $AZURE_LOCATION --admin-user $AZURE_POSTGRES_ADMIN_USER --admin-password $AZURE_POSTGRES_ADMIN_PASSWORD --storage-size $STORAGE --sku-name $SKU
</code></pre></div><p>The provisioning process will take a few minutes.</p> <p>To check the details of the Postgres database instance you just provisioned, invoke <code>az postgres server show</code> command</p> <div class="language- extra-class"><pre class="language-text"><code>az postgres server show --resource-group $AZURE_RESOURCE_GROUP_NAME --name $AZURE_POSTGRES_SERVER_NAME
</code></pre></div><p>You should get a JSON response. Please note down the value for the <code>fullyQualifiedDomainName</code> attribute as you will be using this to connect to the Postgres instance later.</p> <blockquote><p><em>It should be of the format:</em> <code>*[AZURE_POSTGRES_DB_NAME].postgres.database.azure.com*</code></p></blockquote> <hr> <h1 id="azure-kubernetes-service-aks-setup"><a href="#azure-kubernetes-service-aks-setup" class="header-anchor">#</a> Azure Kubernetes Service (AKS) setup</h1> <p>You need the <code>az aks create</code> command to stand up a Kubernetes cluster on Azure</p> <blockquote><p><em>To keep things simple, the below command creates a single node cluster. Feel free to change the specification as per your requirements</em></p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>export AKS_CLUSTER_NAME=[to be filled]az aks create --resource-group $AZURE_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --node-count 1 --node-vm-size Standard_B2s --node-osdisk-size 30 --generate-ssh-keys
</code></pre></div><p>Get the AKS cluster credentials using <code>az aks get-credentials</code> - as a result, <code>kubectl</code> will now point to your new cluster. You can confirm the same</p> <div class="language- extra-class"><pre class="language-text"><code>az aks get-credentials --resource-group $AZURE_RESOURCE_GROUP --name $AKS_CLUSTER_NAMEkubectl get nodes
</code></pre></div><blockquote><p><em>If you are interested in learning Kubernetes and Containers using</em> <a href="https://azure.microsoft.com/services/kubernetes-service/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer"><em>Azure</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><em>, simply</em> <a href="https://azure.microsoft.com/en-us/free/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer"><em>create a</em> ***free***<em>account</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <em>and get going! A good starting point is to use the</em> <a href="https://docs.microsoft.com/azure/aks/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer"><em>quickstarts, tutorials and code samples</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <em>in the documentation to familiarize yourself with the service. I also highly recommend checking out the</em> <a href="https://azure.microsoft.com/resources/kubernetes-learning-path/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer"><em>50 days Kubernetes Learning Path</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><em>. Advanced users might want to refer to</em> <a href="https://docs.microsoft.com/azure/aks/best-practices?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer"><em>Kubernetes best practices</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <em>or the watch some of the</em> <a href="https://azure.microsoft.com/resources/videos/index/?services=kubernetes-service&amp;WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer"><em>videos</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <em>for demos, top features and technical sessions.</em></p></blockquote> <h2 id="allow-aks-to-access-the-postgres-database"><a href="#allow-aks-to-access-the-postgres-database" class="header-anchor">#</a> Allow AKS to access the Postgres database</h2> <p>The Postgres database is not accessible to external services by default. We can use the <code>az postgres server firewall-rule create</code> command to create a firewall rule to explicitly allow Azure services to access the Postgres instance. This will allow the JavaEE application deployed in AKS to communicate with Postgres.</p> <div class="language- extra-class"><pre class="language-text"><code>export FIREWALL_RULE_NAME=AllowJavaEECafeAppOnAKSaz postgres server firewall-rule create --resource-group $AZURE_RESOURCE_GROUP_NAME --server-name $AZURE_POSTGRES_SERVER_NAME --start-ip-address=0.0.0.0 --end-ip-address=0.0.0.0 --name $FIREWALL_RULE_NAME
</code></pre></div><blockquote><p><em>Note: This setting allows network connections from all IPs within the Azure network. For production use, try to configure the most restrictive firewall rules possible</em></p></blockquote> <hr> <h1 id="setup-azure-container-registry"><a href="#setup-azure-container-registry" class="header-anchor">#</a> Setup Azure Container Registry</h1> <p>Azure Container Registry is a managed, private Docker registry service to store and manage your private Docker container images (it based on the open-source Docker Registry 2.0). You can use Azure container registries with your existing container development and deployment pipelines, or use <a href="https://docs.microsoft.com/azure/container-registry/container-registry-tasks-overview?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">Azure Container Registry Tasks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to build container images in Azure. You can either build on-demand, or fully automate builds with triggers such as source code commits and base image updates.</p> <p>Let’s create a registry to store the Docker image for the JavaEE application. We will use the <code>az acr create</code>command</p> <div class="language- extra-class"><pre class="language-text"><code>export ACR_NAME=[to-be-filled]az acr create --resource-group $AZURE_RESOURCE_GROUP_NAME --name $ACR_NAME --sku Basic --admin-enabled true
</code></pre></div><blockquote><p><em>We are using the</em> <code>*Basic*</code> <em>SKU. Valid value are:</em> <code>*Basic*</code><em>,</em> <code>*Classic*</code><em>,</em> <code>*Premium*</code><em>,</em> <code>*Standard*</code></p></blockquote> <p>You can log in to the registry once it’s created and check the login server</p> <div class="language- extra-class"><pre class="language-text"><code>az acr login --name $ACR_NAME
az acr show --name $ACR_NAME --query loginServer --output table
</code></pre></div><blockquote><p><em>You will use the ACR login server name soon. Its value follows the format:</em> <code>*[ACR_NAME].azurecr.io*</code></p></blockquote> <h2 id="configure-azure-container-registry-to-work-with-azure-kubernetes-service"><a href="#configure-azure-container-registry-to-work-with-azure-kubernetes-service" class="header-anchor">#</a> Configure Azure Container Registry to work with Azure Kubernetes Service</h2> <p>To access images stored in <code>Azure Container Registry</code>, you must grant the <code>Azure Kubernetes Service</code> service principal the correct rights to pull images from ACR.</p> <p>Get the <code>appId</code> of the service principal which is associated with your AKS cluster</p> <div class="language- extra-class"><pre class="language-text"><code>AKS_SERVICE_PRINCIPAL_APPID=$(az aks show --name $AKS_CLUSTER_NAME --resource-group $AZURE_RESOURCE_GROUP --query servicePrincipalProfile.clientId -o tsv)
</code></pre></div><p>Find the resource ID for Azure Container Registry</p> <div class="language- extra-class"><pre class="language-text"><code>ACR_RESOURCE_ID=$(az acr show --resource-group $AZURE_RESOURCE_GROUP --name $ACR_NAME --query &quot;id&quot; --output tsv)
</code></pre></div><p>Grant <code>acrpull</code> permissions to AKS service principal</p> <div class="language- extra-class"><pre class="language-text"><code>az role assignment create --assignee $AKS_SERVICE_PRINCIPAL_APPID --scope $ACR_RESOURCE_ID --role acrpull
</code></pre></div><p>Our AKS cluster along with ACR is ready to use!</p> <hr> <h1 id="setup-and-prepare-application-image"><a href="#setup-and-prepare-application-image" class="header-anchor">#</a> Setup and prepare application image</h1> <p>Clone the git repository</p> <div class="language- extra-class"><pre class="language-text"><code>git clone https://github.com/abhirockzz/javaee-on-azure-kubernetes
cd javaee-on-azure-kubernetes
</code></pre></div><p>You need to enter the Postgres connectivity information to the ``attribute of the <code>section in</code>web.xml`.</p> <blockquote><p><em>You can find the</em> <code>*web.xml*</code> <em>file under</em> <code>*javaee-on-azure-iaas/src/main/webapp/WEB-INF*</code></p></blockquote> <p>The format is as follows:</p> <div class="language- extra-class"><pre class="language-text"><code>jdbc:postgresql://[POSTGRES_FQDN]:5432/postgres?user=[AZURE_POSTGRES_ADMIN_USER]@[AZURE_POSTGRES_SERVER_NAME]&amp;amp;password=[AZURE_POSTGRES_ADMIN_PASSWORD]&amp;amp;sslmode=require
</code></pre></div><p>Here are the list placeholders which form a part of the JDBC URL:</p> <ul><li><code>POSTGRES_FQDN</code> with value of <code>fullyQualifiedDomainName</code></li> <li><code>AZURE_POSTGRES_ADMIN_USER</code> with admin user name used to provision PG</li> <li><code>AZURE_POSTGRES_SERVER_NAME</code> with server name used to provision PG</li> <li><code>AZURE_POSTGRES_ADMIN_PASSWORD</code> with admin password used to provision PG</li></ul> <p>Set the required values</p> <div class="language- extra-class"><pre class="language-text"><code>export POSTGRES_FQDN=[to be filled]
export AZURE_POSTGRES_ADMIN_USER=[to be filled]
export AZURE_POSTGRES_SERVER_NAME=[to be filled]
export AZURE_POSTGRES_ADMIN_PASSWORD=[to be filled]
</code></pre></div><p>Simply use these commands to replace</p> <div class="language- extra-class"><pre class="language-text"><code>export FILE_NAME=javaee-on-azure-iaas/src/main/webapp/WEB-INF/web.xmlsed -i 's/POSTGRES_FQDN/'&quot;$POSTGRES_FQDN&quot;'/g' $FILE_NAME
sed -i 's/AZURE_POSTGRES_SERVER_NAME/'&quot;$AZURE_POSTGRES_SERVER_NAME&quot;'/g' $FILE_NAME
sed -i 's/AZURE_POSTGRES_ADMIN_USER/'&quot;$AZURE_POSTGRES_ADMIN_USER&quot;'/g' $FILE_NAME
sed -i 's/AZURE_POSTGRES_ADMIN_PASSWORD/'&quot;$AZURE_POSTGRES_ADMIN_PASSWORD&quot;'/g' $FILE_NAME
</code></pre></div><p>Here is an e.g. of what the `` section will look like:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;data-source&gt;
        &lt;name&gt;java:global/JavaEECafeDB&lt;/name&gt;
        &lt;class-name&gt;org.postgresql.ds.PGPoolingDataSource&lt;/class-name&gt;
        &lt;url&gt;jdbc:postgresql://foobar-pg.postgres.database.azure.com:5432/postgres?user=foobar@foobar-pg&amp;amp;password=foobarbaz&amp;amp;sslmode=require&lt;/url&gt;
    &lt;/data-source&gt;
</code></pre></div><p>The application is now configured. Let’s build it!</p> <div class="language- extra-class"><pre class="language-text"><code>mvn clean install
</code></pre></div><p>You should have the WAR file available. To confirm</p> <div class="language- extra-class"><pre class="language-text"><code>ls -lrt target | grep javaee-cafe.war
</code></pre></div><h2 id="build-and-push-the-image-to-azure-container-registry"><a href="#build-and-push-the-image-to-azure-container-registry" class="header-anchor">#</a> Build and push the image to Azure Container Registry</h2> <p>Our application artifact (<code>WAR</code> file) is ready. We can now build the Docker image and push it out to Azure Container Registry. Here is a quick look at the Dockerfile used for this</p> <div class="language- extra-class"><pre class="language-text"><code>FROM payara/server-full
COPY target/javaee-cafe.war $DEPLOY_DIR
RUN wget https://jdbc.postgresql.org/download/postgresql-42.2.8.jar
RUN cp /opt/payara/postgresql-42.2.8.jar ${PAYARA_DIR}/glassfish/domains/${DOMAIN_NAME}/lib &amp;&amp; rm /opt/payara/postgresql-42.2.8.jar
EXPOSE 8080
</code></pre></div><p>It builds on top of the base image for <code>payara/server-full</code>, copies the <code>WAR</code>file to a folder from where it can be automatically detected and deployed, downloads the Postgres JDBC driver and places it in the appropriate location for the Payara application server. That's it!</p> <div class="language- extra-class"><pre class="language-text"><code>export DOCKER_IMAGE=javaee-cafe
docker build -t $DOCKER_IMAGE .
docker tag $DOCKER_IMAGE $ACR_NAME.azurecr.io/$DOCKER_IMAGE
</code></pre></div><p>To push the image</p> <div class="language- extra-class"><pre class="language-text"><code>docker push $ACR_NAME.azurecr.io/$DOCKER_IMAGE
</code></pre></div><p>For e.g., if the <code>ACR_NAME</code> (name of the Azure Container Registry) is <code>javaeecafe-acr</code>, the resulting Docker image will be <code>javaeecafe-acr.azurecr.io/javaee-cafe</code></p> <p>Use <code>az acr repository list</code> command to check the image.</p> <div class="language- extra-class"><pre class="language-text"><code>az acr repository list --name $ACR_NAME --output table
</code></pre></div><hr> <h1 id="deploy-the-application-to-azure-kubernetes-service"><a href="#deploy-the-application-to-azure-kubernetes-service" class="header-anchor">#</a> Deploy the application to Azure Kubernetes Service</h1> <p>Before deploying the application, please update the Kubernetes manifest file <code>javaee-cafe.yaml</code> with the name of the Docker image. To be specific, update the <code>spec.containers.image</code> with the name of the Azure Container Registry which you specified above</p> <blockquote><p><em>It is assumed that the name of the Docker image is</em> <code>*javaee-azure*</code><em>, if not please update that as well</em></p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>spec:
  containers:
    - name: javaee-cafe
      image: &lt;replace_me&gt;.azurecr.io/javaee-azure
</code></pre></div><p>For e.g.</p> <div class="language- extra-class"><pre class="language-text"><code>spec:
  containers:
    - name: javaee-cafe
      image: javaeecafe-acr.azurecr.io/javaee-azure
</code></pre></div><p>To deploy the application</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl apply -f javaee-cafe.yml
</code></pre></div><p>This should spin up a <code>Pod</code>. Wait for it to transition to <code>Running</code> state.</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl get pods -l=app=javaee-cafe -w
</code></pre></div><p>Once the <code>Pod</code> is <code>Running</code>, confirm that the application has been deployed successfully</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl logs -f &lt;replace_with_pod_name&gt;
</code></pre></div><p>The application deployment should be in progress and finally, you should see the logs similar to the one below (with the <code>Successfully autodeployed</code>message)</p> <div class="language- extra-class"><pre class="language-text"><code>[AutoDeploy] Successfully autodeployed : /foo/bar/payara5/glassfish/domains/domain1/autodeploy/javaee-cafe.war.]]
</code></pre></div><hr> <h1 id="explore-the-application"><a href="#explore-the-application" class="header-anchor">#</a> Explore the application</h1> <p>We use a <code>LoadBalancer</code> <code>Service</code> type to ensure that our Java EE app is accessible outside of the cluster. The creation of a Kubernetes <code>LoadBalancer``Service</code> in Azure does exactly what it's supposed to i.e. provision an <a href="https://docs.microsoft.com/azure/load-balancer/?WT.mc_id=azuremedium-blog-abhishgu" target="_blank" rel="noopener noreferrer">Azure Load Balancer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> behind the scenes.</p> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: v1
kind: Service
metadata:
  name: javaee-cafe
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 8080
  selector:
    app: javaee-cafe
</code></pre></div><p>We can get the load balancer IP by using</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl get svc javaee-cafe
</code></pre></div><blockquote><p><em>where</em> <code>*javaee-cafe*</code> <em>is the name of the</em> <code>*Service*</code></p></blockquote> <p>The value of the <code>EXTERNAL-IP</code> is the load balancer IP and will be used to access the application</p> <h2 id="access-the-jsf-front-end"><a href="#access-the-jsf-front-end" class="header-anchor">#</a> Access the JSF front end</h2> <p>Use your browser to access <code>http://[LOAD_BALANCER_IP]/javaee-cafe</code>. You can use the UI to create, delete and see coffees.</p> <p><img src="https://miro.medium.com/max/60/1*rbEWA7qQYoqUKAtCfqLdZQ.png?q=20" alt="img"></p> <p><img src="https://miro.medium.com/max/5944/1*rbEWA7qQYoqUKAtCfqLdZQ.png" alt="img"></p> <h2 id="use-the-rest-api"><a href="#use-the-rest-api" class="header-anchor">#</a> Use the REST API</h2> <p>The application also exposes a REST API for creating, deleting and listing coffees.</p> <div class="language- extra-class"><pre class="language-text"><code>export JAVAEE_AKS_REST=http://[LOAD_BALANCER_IP]/javaee-cafe/rest/coffees
</code></pre></div><p>e.g.</p> <div class="language- extra-class"><pre class="language-text"><code>export JAVAEE_AKS_REST=http://23.101.24.139/javaee-cafe/rest/coffees
</code></pre></div><p>Create coffees</p> <div class="language- extra-class"><pre class="language-text"><code>curl -X POST $JAVAEE_AKS_REST -d '{&quot;name&quot;:&quot;cappuccino&quot;,&quot;price&quot;:&quot;10&quot;}' -H &quot;Content-Type: application/json&quot;curl -X POST $JAVAEE_AKS_REST -d '{&quot;name&quot;:&quot;caffe-latte&quot;,&quot;price&quot;:&quot;15&quot;}' -H &quot;Content-Type: application/json&quot;
</code></pre></div><p>Get all coffees</p> <div class="language- extra-class"><pre class="language-text"><code>curl -H &quot;Accept: application/json&quot; $JAVAEE_AKS_REST
</code></pre></div><p>You should see a JSON response listing both the coffee options you just added</p> <p>Get a coffee by ID</p> <div class="language- extra-class"><pre class="language-text"><code>curl -H &quot;Accept: application/json&quot; $JAVAEE_AKS_REST/1
</code></pre></div><p>Delete a coffee by ID</p> <div class="language- extra-class"><pre class="language-text"><code>curl -X DELETE $JAVAEE_AKS_REST/1
curl -H &quot;Accept: application/json&quot; $JAVAEE_AKS_REST
</code></pre></div><p>Notice that <code>cappuccino</code> is now deleted</p> <h2 id="scale"><a href="#scale" class="header-anchor">#</a> Scale</h2> <p>Right now, we have one instance of our application since we had set <code>spec.replicas</code> to <code>1</code> in the Kubernetes manifest. We can scale our application horizontally and Kubernetes will ensure that it spins up and maintains the required number of <code>Pod</code>s. To add another instance</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl scale deployment javaee-cafe --replicas=2
</code></pre></div><p>To confirm that another <code>Pod</code> has been spun up:</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl get pods -l=app=javaee-cafe -w
</code></pre></div><p>You can continue accessing the application in the same manner and now the requests will be transparently load balanced amongst your app instances by the Load Balancer.</p> <hr> <h1 id="clean-up-resources"><a href="#clean-up-resources" class="header-anchor">#</a> Clean up resources</h1> <p>Once you are done exploring the application, you can delete the resources. Since we used a resource group, it’s as easy as executing a single command.</p> <blockquote><p><em>Please be aware that this will delete all the resources in the group which includes the ones you created as part of the tutorial as well as any other service instances you might have if you used an</em> already existing <em>resource group</em></p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>az group delete --name $AZURE_RESOURCE_GROUP_NAME
</code></pre></div><h1 id="summary"><a href="#summary" class="header-anchor">#</a> Summary</h1> <p>You learned how to leverage Docker containers to package your Java EE application and deploy it to a Kubernetes cluster in Azure along with a managed database offering for long term persistence.</p> <p>That brings us to the end of this series exploring some of the common ways of deploying Java EE workloads to Azure. I hope you found it useful! 🙌</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/shinyzhu/azureselected/edit/master/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-3.md" target="_blank" rel="noopener noreferrer">Edit on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/3/2020, 4:02:04 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/azureselected/content/cloud-advocate/2020-01/deploying-java-ee-apps-to-azure-part-2.html" class="prev">
        部署 Java EE 应用到 Azure: 第 2 部分
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/azureselected/assets/js/app.8a0b7483.js" defer></script><script src="/azureselected/assets/js/2.8d021b4d.js" defer></script><script src="/azureselected/assets/js/20.84db9ad2.js" defer></script><script src="/azureselected/assets/js/3.32c85e2e.js" defer></script><script src="/azureselected/assets/js/5.554b9b17.js" defer></script>
  </body>
</html>
